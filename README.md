# VisualHyDe: A Python Script for Visualizing and Analyzing Hybridization Signals

VisualHyDe is a Python script designed to visualize, analyze, and critically evaluate hybridization signals detected by the software [HyDe](https://github.com/pblischak/hyde). It provides a robust framework for interpreting the extensive output of HyDe across a large phylogeny, helping to distinguish genuine introgression events from statistical artifacts.

The script enhances raw HyDe results by providing intuitive heatmap visualizations, implementing a novel algorithm for inferring ancestral hybridization events, and offering a sophisticated workflow for filtering out false positives caused by evolutionary rate heterogeneity.

---

## Table of Contents
- [Key Features](#key-features)
- [Dependencies](#dependencies)
- [Installation](#installation)
- [Usage](#usage)
  - [Command-Line Options](#command-line-options)
- [Input File Requirements](#input-file-requirements)
- [Modes of Operation](#modes-of-operation)
  - [Leaf Mode](#leaf-mode)
  - [Node Mode: The "Difference Consensus" Algorithm](#node-mode-the-difference-consensus-algorithm)
- [False Positive Filtering](#false-positive-filtering)
  - [Rationale](#rationale)
  - [The Relative Strength Test](#the-relative-strength-test)
- [Recommended Analysis Workflow](#recommended-analysis-workflow)
  - [Data Preparation](#data-preparation)
  - [Step 1: Simulation of the Null-Hypothesis Dataset](#step-1-simulation-of-the-null-hypothesis-dataset)
  - [Step 2: HyDe Analysis on Empirical and Simulated Data](#step-2-hyde-analysis-on-empirical-and-simulated-data)
  - [Step 3: Generation of Null-Hypothesis Filter Layers](#step-3-generation-of-null-hypothesis-filter-layers)
  - [Step 4: Final Analysis of Empirical Data with Filtering](#step-4-final-analysis-of-empirical-data-with-filtering)
- [Output Files](#output-files)
- [Citation & Contact](#citation--contact)

---

## Key Features

- **Leaf Mode Visualization**: Generates an intuitive heatmap of hybridization signals for a single taxon (leaf), showing contributions from all potential parental pairs.
- **Ancestral State Inference (Node Mode)**: Implements a novel two-stage **"Difference Consensus" algorithm** to infer ancient hybridization events at internal nodes of the phylogeny, aggregating signals from all descendants to distinguish clade-wide events from lineage-specific noise.
- **Sophisticated False-Positive Filtering**: Addresses errors caused by heterogeneity in evolutionary rates by simulating data under a null hypothesis (no gene flow). It then compares real signals to this baseline to remove artifacts.
- **Mode-Aware Filtering Logic**: Applies the null-hypothesis filter differently for Leaf Mode and Node Mode to ensure maximum robustness without compromising the integrity of the ancestral inference algorithm.
- **Automated Clade Highlighting**: Automatically defines and colors clades in the output phylogeny for easier interpretation, or accepts a user-defined file.
- **Rigorous Input Validation**: Performs strict checks on taxon name consistency across all input files to prevent erroneous analysis.

## Dependencies

The script requires Python 3 and the following libraries:
- `ete3`
- `matplotlib`
- `numpy`
- `pandas`
- `Pillow`

## Installation

1.  **Clone the repository:**

        git clone https://github.com/your-username/VisualHyDe.git
        cd VisualHyDe

2.  **Install dependencies using Conda:** It is highly recommended to use a Conda environment to manage the dependencies.

        conda create -n hyde_env python=3.6
        conda activate hyde_env
        conda install -c etetoolkit ete3 ete_toolchain
        conda install matplotlib numpy pandas pillow

## Usage

The script is run from the command line.

**Basic Leaf Mode Example:**

    python visual_hyde.py -t species_tree.nwk -i hyde_output.txt -p 0.05

**Advanced Node Mode Example with Filtering:**

    python visual_hyde.py \
        -t ml_tree.nwk \
        -i empirical_hyde_results.txt \
        -n \
        --filter_dir ./null_hypothesis_results/ \
        --diff_consensus_ratio 0.8 \
        --diff_consensus_threshold 0.1 \
        -p 0.05

### Command-Line Options

#### **Required arguments**
| Argument | Description |
|---|---|
| `-i`, `--infile FILE` | The tab-delimited output file generated by HyDe. Must contain the header: `P1`, `P2`, `Hybrid`, `Gamma`, `Pvalue`. |
| `-t`, `--treefile FILE` | A fully resolved species tree in Newick format. This tree provides the topological framework and must be rooted with a single outgroup. |

#### **Arguments for Node Mode**
| Argument | Description |
|---|---|
| `-n`, `--node` | Activates **Node Mode**, which uses the "difference consensus" algorithm to infer ancestral hybridization signals. |
| `-gdt`, `--gamma_diff_threshold F` | (Stage 1) The **loose** gamma difference threshold for the initial draft heatmap calculation. Default: `0.2`. |
| `--diff_consensus_threshold F` | (Stage 2) The **strict** threshold for a gamma difference to be considered 'low' during the consensus test. Default: `0.1`. |
| `--diff_consensus_ratio F` | (Stage 2) The minimum ratio of descendant internal nodes that must have a 'low' gamma difference to confirm an ancestral signal. Default: `0.8`. |

#### **Optional False Positive Filtering**
| Argument | Description |
|---|---|
| `--filter_dir DIR` | Path to a directory containing null-hypothesis CSV files for false positive filtering. See workflow for details. |
| `--filter_ratio_threshold F` | The ratio threshold for the "relative strength test". A signal is filtered if the strength of the null signal relative to the real signal is above this value. Default: `0.05`. |

#### **Other arguments**
| Argument | Description |
|---|---|
| `-c`, `--preclade FILE` | A comma-separated text file that defines clades for color-highlighting. If not provided, one is generated automatically. |
| `-l`, `--leaves LEAF` | (Leaf Mode only) Process only a single, specified leaf instead of all possible leaves. |
| `-p`, `--pvalue F` | The p-value threshold below which a hybridization triplet is considered statistically significant. Default: `0.05`. |

---

## Input File Requirements

Strict consistency in taxon nomenclature across all files is **mandatory**.

1.  **Species Tree (`-t`)**: A rooted, fully resolved species tree in Newick format. The tree must contain a single outgroup. If using the false positive filter, this should be a maximum likelihood tree with accurate branch lengths.

2.  **HyDe Output File (`-i`)**: The standard tab-delimited file from a HyDe analysis. It must contain a header and the five columns: `P1`, `P2`, `Hybrid`, `Gamma`, and `Pvalue`.

3.  **Predefined Clade File (`-c`)** (Optional): A simple text file where each line contains the comma-separated names of taxa belonging to a clade you wish to highlight with a specific color (e.g., `SpeciesA,SpeciesB,SpeciesC,`). If not provided, the script generates a basic one automatically.

4.  **Null Hypothesis Filter Directory (`--filter_dir`)** (Optional): A directory containing a set of `.csv` files generated from a null-hypothesis simulation. The naming must strictly match the output names (e.g., `SpeciesA.csv` for a leaf, `Node_1.csv` for an internal node) and the internal structure must match the main species tree. See the workflow below for how to generate these files.

---

## Modes of Operation

### Leaf Mode

This is the fundamental analysis mode, designed to visualize the hybridization profile for a single terminal taxon (a "leaf"). For a given hybrid `H`, the script filters for all significant parental pairs (P1, P2) and visualizes the results as a heatmap. The color of each cell in the heatmap corresponds to the `gamma` value, representing the proportion of genetic material the hybrid inherited from the parent on the y-axis (P1). Blocks of similar colors can suggest that the true parent was an ancestor of a specific clade.

### Node Mode: The "Difference Consensus" Algorithm

While Leaf Mode is informative, it may not capture ancient introgression events. A signal in one leaf could be recent or just statistical noise. Node Mode is designed to identify these ancestral events by aggregating signals from all descendants of an internal node.

To do this robustly, VisualHyDe uses a novel two-stage **"difference consensus" algorithm**:

1.  **Stage 1: Postorder Traversal (Bottom-up)**: The script moves up the tree from the leaves. For each internal node, it compares the gamma values from its two direct children. If the difference is below a **loose** threshold (`-gdt`), the average gamma value is passed up. This prevents the premature loss of a signal due to minor inconsistencies.

2.  **Stage 2: Preorder Traversal (Top-down)**: The script then moves down the tree to apply a much stricter filter. For a signal to be confirmed at an ancestral node, the vast majority of its descendants (defined by `--diff_consensus_ratio`) must show highly consistent gamma signals (i.e., a difference below the **strict** threshold, `--diff_consensus_threshold`).

This two-tiered approach is resilient to localized noise (e.g., from one poor-quality sample) while rigorously testing for a strong, clade-wide consensus, allowing for confident inference of ancestral hybridization events.

---

## False Positive Filtering

### Rationale

Methods like HyDe, which are based on phylogenetic quartet frequencies (e.g., ABBA-BABA test), can be confounded when applied to distantly related clades with significant variation in evolutionary rates. A rapidly evolving lineage can accumulate mutations that coincidentally mimic the patterns of gene flow, leading to a statistically significant but biologically incorrect hybridization signal.

VisualHyDe addresses this by simulating sequence data on the user's species tree under a **null hypothesis of zero hybridization**. Any "hybridization" signal detected in this simulated dataset is, by definition, a false positive caused by the tree's specific topology and branch lengths. This provides a baseline for systemic bias.

### The Relative Strength Test

Simply removing any signal that also appears in the null simulation would be too harsh. Instead, the script employs a 'relative strength test'.

1.  For a given parental pair, the gamma values from the real data (`gamma_real`) and the null simulation (`gamma_null`) are standardized to a 0-0.5 scale.
2.  A ratio of the null signal strength to the real signal strength is calculated: `R = s(gamma_null) / s(gamma_real)`.
3.  The real signal is discarded as a likely false positive only if this ratio `R` is greater than or equal to a user-defined threshold (`--filter_ratio_threshold`), meaning the background noise is non-negligible compared to the empirical signal.

---

## Recommended Analysis Workflow

This comprehensive workflow ensures the most robust and reliable inference of hybridization.

### Data Preparation

1.  **Sequence Alignment**: Start with a concatenated, multi-locus sequence alignment. An alignment of at least 1 million base pairs (bp) is recommended. The alignment **must contain exactly one outgroup taxon** that is not excessively divergent from the ingroup.
2.  **Species Tree Inference**: Infer a maximum likelihood (ML) species tree from the alignment using software like [RAxML](https://github.com/stamatak/standard-RAxML). You will need two output files from this step:
    * The best-scoring ML tree (e.g., `RAxML_bestTree.*`), correctly rooted with the outgroup.
    * The information file (e.g., `RAxML_info.*`), which contains the estimated substitution model parameters needed for simulation.

### Step 1: Simulation of the Null-Hypothesis Dataset

Generate a sequence alignment under the null hypothesis of no hybridization.

-   **Method**: Use a forward-time sequence evolution simulator, such as the `pyvolve` Python module. You can use a wrapper script like [`phylogenomic_dataset_simulator`](https://github.com/jian-he/phylogenomic_dataset_simulator) to streamline this.
-   **Inputs**: The rooted ML tree and the substitution model parameters from the Data Preparation step.
-   **Recommendation**: Simulate a large alignment (e.g., 5 million bp) to ensure even weak false positive signals can be detected.
-   **Output**: A simulated sequence alignment that has the same evolutionary history as your species tree but is guaranteed to have no gene flow.

### Step 2: HyDe Analysis on Empirical and Simulated Data

Run the HyDe software twice, once on your real (empirical) alignment and once on the simulated null-hypothesis alignment.

-   **Mapping File**: Create a HyDe mapping file where every individual sample is assigned its own unique taxon ID, even if multiple samples belong to the same species. This maximizes the information retained.
-   **HyDe Output**: Use the **unfiltered** HyDe output for both runs (the one containing all tested triplets). VisualHyDe will perform its own p-value filtering.

### Step 3: Generation of Null-Hypothesis Filter Layers

Use VisualHyDe to process the HyDe results from the **simulated data** to create the filter files.

1.  **Run in Leaf Mode**:
    
        python visual_hyde.py -t ml_tree.nwk -i simulated_hyde_results.txt
    
    This generates a `.csv` file for every taxon.

2.  **Run in Node Mode**:

        python visual_hyde.py -t ml_tree.nwk -i simulated_hyde_results.txt -n
    
    This generates a `.csv` file for every internal node.

3.  **Collect Files**: Create a new, empty directory and move all `.csv` files generated in these two runs into it. This directory is your `--filter_dir`.

### Step 4: Final Analysis of Empirical Data with Filtering

Now, analyze your empirical data using the filter you just created.

1.  **Unfiltered Analysis (Optional but Recommended)**: First, run VisualHyDe on your empirical HyDe results *without* the `--filter_dir` argument. This shows you all raw, statistically significant signals, though they may contain false positives. It is wise to back up these results in a separate folder.

        python visual_hyde.py -t ml_tree.nwk -i empirical_hyde_results.txt -n 
        # (or without -n for leaf mode)

2.  **Filtered Analysis (Final)**: Re-run the analysis on the same empirical data, but this time provide the path to the null-hypothesis directory created in Step 3. The script will now perform the "relative strength test", removing false positives.

        python visual_hyde.py \
            -t ml_tree.nwk \
            -i empirical_hyde_results.txt \
            -n \
            --filter_dir ./path/to/your/null_results/ 
    
    The resulting visualizations are now corrected for systemic biases and represent a much more robust and reliable depiction of the hybridization events in your data.

## Output Files

For each leaf or node analyzed (e.g., `SpeciesA`), the script generates:
-   **`SpeciesA_combined.png`**: The final, combined visualization containing the heatmap and annotated phylogenies.
-   **`SpeciesA.csv`**: A CSV file containing the raw `gamma` values for the heatmap matrix.
-   **`Node_X_calculation_details.tsv`** (Node Mode only): A tab-separated file detailing the results of the "difference consensus" test for each potential parental pair, providing full transparency on how the final heatmap was constructed.

## Citation & Contact

This script was created by Jian He (`j.he930724@gamail.com`) and modified for enhanced logging and advanced algorithms by the Assistant.

If you use VisualHyDe in your research, please cite this GitHub repository and the original HyDe paper.
