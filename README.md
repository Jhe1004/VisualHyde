# VisualHyDe: Visualization of Hybridization Detection Results

VisualHyDe is a Python script designed to assist in the visualization and synthesis of hybridization detection results generated by the HyDe software package. It creates integrated visualizations of a species phylogeny and HyDe results, offering two primary operational modes: "Leaf Mode" and "Node Mode".

This script was developed by Jian He (j.he930724@gmail.com). 

## Overview

[HyDe](https://github.com/pblischak/HyDe) is a software package that tests for hybridization using a 4-taxon model ((P1, H, P2), O) and estimates the inheritance probability (γ) – the proportion of the putative hybrid’s (H) genome inherited from parental lineage P1. Interpreting the large volume of output from comprehensive HyDe runs can be challenging. VisualHyDe aims to simplify this by generating informative figures.

**Key Features:**

* **Leaf Mode:** Focuses on a single contemporary sample (a leaf node) as the putative hybrid. It generates a heatmap showing potential parental contributions (P1 and P2) to this hybrid, integrated with the species phylogeny. This mode helps in identifying potential parental lineages for individual samples.
* **Node Mode:** Infers ancestral hybridization signals. It systematically progresses from the tips of the tree inwards, validating signals based on consistency between descendant lineages. A signal for an ancestral node is inferred if its descendant lineages show statistically significant and comparable γ values for the same parental pair. This mode helps identify robust historical hybridization events.
* **Integrated Visualization:** Combines heatmaps with the species phylogeny, allowing for direct interpretation of hybridization signals within their evolutionary context.

## Dependencies

To run `visual_hyde.py`, you will need:

* Python 3
* ete3:
    **Note on ete3 installation:** Due to potential compatibility issues, installing ete3 in Python 3.10 and newer environments can be challenging. It is highly recommended to create a dedicated conda environment with Python 3.6 for ete3 installation:
    ```bash
    conda create -n py36_ete3 python=3.6
    conda activate py36_ete3
    conda install -c etetoolkit ete3 ete_toolchain
    ```
    You can then run `visual_hyde.py` within this `py36_ete3` environment.
* matplotlib:
    `conda install matplotlib`
* numpy:
    `conda install numpy`
* pandas:
    `conda install pandas`
* Pillow (PIL):
    `conda install Pillow` or `pip install Pillow`
* colorsys (standard Python library)

## Input Files

1.  **HyDe Output File (`-i`, `--infile`):**
    * A tab-separated file generated by HyDe.
    * **Required columns:** `P1`, `Hybrid`, `P2`, `Zscore`, `Gamma`.
    * The script filters these results based on significance (e.g., Z-score > 3.0, and 0 < Gamma < 1).
2.  **Species Tree File (`-t`, `--treefile`):**
    * A species tree in Newick format.
    * **Important:** This tree **must be rooted**, and the designated outgroup in this tree should be the **same outgroup taxon used when running HyDe**. The script's logic for ingroup/outgroup determination and visualization relies on this consistency.
    * Leaf names in this tree **must** also be consistent with the names used in the HyDe output file for P1, Hybrid, and P2. The script includes a name consistency check.

3.  **Predefined Clades File (`-c`, `--preclade`) (Optional):**
    * A text file defining clades to be highlighted on the tree.
    * Each line should contain comma-separated leaf names belonging to a clade (e.g., `speciesA,speciesB,speciesC,`).
    * If not provided, or if the specified file is not found, the script will attempt to automatically generate a simple `Predefined_clade.txt` file based on the input tree, where clades will contain a maximum of 5 leaf nodes by default.

## Usage

    python visual_hyde.py -i <hyde_output_file> -t <species_tree_file> [options]

**Required Arguments:**

* `-i FILE`, `--infile FILE`: Path to the HyDe output file.
* `-t FILE`, `--treefile FILE`: Path to the species tree file in Newick format.

**Additional Arguments:**

* `-n`, `--node`: Activate Node Mode. If not specified, the script runs in Leaf Mode by default.
* `-gdt F`, `--gamma_diff_threshold F`: (Node Mode only) Gamma difference threshold for averaging signals from descendant nodes. If the absolute difference in gamma values between two child nodes for the same P1/P2 pair is greater than this threshold, the ancestral signal is considered unsupported. Default: `0.2`.
* `-c FILE`, `--preclade FILE`: Path to the predefined clades file. If not provided, an attempt will be made to auto-generate it.
* `-l LEAF`, `--leaves LEAF`: (Leaf Mode only) Process only a single specified leaf (hybrid). If not used, all relevant leaves found as 'Hybrid' in the HyDe output will be processed.
* `-z F`, `--zscore F`: Z-score threshold for filtering HyDe results. Only results with a Z-score greater than this value will be considered. Default: `3.0`.

## Output

The script will generate PNG image files in the directory where it is run.

* **Leaf Mode:** For each putative hybrid processed, a combined image `[prefix_]HybridName_combined.png` is generated. This image includes:
    * The species tree on the left.
    * A heatmap in the center-top, where rows and columns are taxa from the tree. Colored cells indicate significant HyDe tests, with color intensity representing the γ value (contribution from the row taxon as P1).
    * The species tree rotated 90 degrees below the heatmap, aligned with the heatmap columns.
    * A colorbar on the right indicating the γ scale.
    * A CSV file `[prefix_]HybridName_hotmap_temp.csv` containing the raw data for the heatmap will also be saved.
* **Node Mode:** For each internal node (excluding the root) that is deemed plottable (binary, with at least two ingroup descendants, and consistent signals from children if applicable), a combined image `Node_X_combined.png` (where X is a sequential number) is generated. The structure is similar to Leaf Mode, but the heatmap represents the inferred ancestral hybridization signals for that internal node.
    * A CSV file `Node_X_hotmap_temp.csv` containing the raw data for the ancestral heatmap will also be saved.

The script also generates temporary files (e.g., `tree_temp.png`, `*_hotmap_temp.png`, `*_colorbar_temp.png`) during processing, which are deleted after the final combined image is created.

## Interpretation of Output

* **Heatmap Colors (γ values):**
    * The heatmap displays γ values, where γ is the proportion of the hybrid's genome inferred to be inherited from P1 (the taxon on the row).
    * The color scale typically ranges from blue (γ ≈ 0, low contribution from P1) to red (γ ≈ 1, high contribution from P1).
    * Values of γ around 0.5 (often greenish or yellowish, depending on the exact colormap generation) suggest roughly equal contribution from P1 and P2.
    * The script generates a full matrix. The value in cell (row=i, col=j) represents γ with taxon i as P1 and taxon j as P2. The value in cell (row=j, col=i) should represent 1-γ from the previous cell, as it considers taxon j as P1 and taxon i as P2 for the same hybridization event.
* **Blocks of Color:** In Leaf Mode, blocks of similar colors in the heatmap can suggest that the hybridization event involved ancestral clades rather than just the specific leaf taxa. For example, if several species from Clade A (as P1) show similar γ values when tested against several species from Clade B (as P2) for a given Hybrid, it might indicate an ancestral hybridization event between the MRCA of Clade A and the MRCA of Clade B.
* **Node Mode Heatmaps:** In Node Mode, a colored cell in the ancestral heatmap indicates a robust ancestral signal that has been validated by consistent evidence (γ values differing by less than the `--gamma_diff_threshold`) in both direct descendant lineages (B and C). White cells now represent scenarios where the ancestral signal was either absent in descendants or, crucially, where the signals inherited by the two children were too divergent to confidently support a single ancestral event involving that P1/P2 pair.

## Example Workflow

1.  **Run HyDe:**
    Perform your hybridization analysis using HyDe. For specific instructions on running HyDe, please refer to the official HyDe GitHub page: [https://github.com/pblischak/HyDe](https://github.com/pblischak/HyDe).
    The output from HyDe (typically a file like `*_hybrid_tests.txt`) will be used as input for VisualHyDe.


2.  **Prepare Inputs and Script for VisualHyDe:**
    * Place the `visual_hyde.py` script in a working directory.
    * In the same directory, place your HyDe output file (e.g., `hyde_results_hybrid_tests.txt`). Ensure it has the required columns (`P1`, `Hybrid`, `P2`, `Zscore`, `Gamma`).
    * Also in this directory, place your species tree file (e.g., `species_tree.nwk`).
    * (Optional) If using a predefined clades file, place `predefined_clades.txt` in this directory as well.
    * It is recommended to run the `visual_hyde.py` script from this working directory.


3.  **Run VisualHyDe (Leaf Mode for a specific hybrid):**

        python visual_hyde.py -i hyde_results_hybrid_tests.txt -t species_tree.nwk -l HybridSpeciesX -c predefined_clades.txt -z 3.0

4.  **Run VisualHyDe (Node Mode):**

        python visual_hyde.py -i hyde_results_hybrid_tests.txt -t species_tree.nwk -n -gdt 0.2 -c predefined_clades.txt -z 3.0


## Citation

If you use VisualHyDe in your research, please cite the accompanying publication and the relevant HyDe papers:

* Blischak, P. D., Chifman, J., Wolfe, A. D., & Kubatko, L. S. (2018). HyDe: a Python package for genome-scale hybridization detection. *Systematic Biology, 67(5)*, 821-829.
* Kubatko, L. S., & Chifman, J. (2019). An invariants-based method for efficient identification of hybrid species from large-scale genomic data. *BMC evolutionary biology, 19*, 1-13.
